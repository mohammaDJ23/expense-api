services:
  expense-api:
    container_name: ${CONTAINER_NAME:-expense-api-ci}
    image: ${IMAGE_NAME:?IMAGE_NAME missing}
    restart: 'no'
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    environment:
      NODE_ENV: production
      PORT: ${PORT:-3000}
      DATABASE_HOST: postgres
      DATABASE_NAME: expense_ci
      DATABASE_PORT: 5432
      DATABASE_USER: expense
      DATABASE_PASSWORD_FILE: /run/secrets/database_password
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      JWT_SECRET_FILE: /run/secrets/jwt_secret
    networks:
      - expense-api-network
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:${PORT}/api/v1/health || exit 1']
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 3
    secrets:
      - database_password
      - redis_password
      - jwt_secret
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  postgres:
    container_name: postgres-ci
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: expense_ci
      POSTGRES_USER: expense_api
      POSTGRES_PASSWORD_FILE: /run/secrets/database_password
    secrets:
      - database_password
    tmpfs:
      - /var/lib/postgresql/data:rw,noexec,nosuid,size=1024m
    networks:
      - expense-api-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U expense_api']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
      start_interval: 5s

  redis:
    container_name: redis-ci
    image: redis:7-alpine
    command: >
      redis-server
        --requirepass file:/run/secrets/redis_password
        --save ''
        --appendonly no
    secrets:
      - redis_password
    networks:
      - expense-api-network
    healthcheck:
      test: ['CMD-SHELL', 'redis-cli -a "$$(cat /run/secrets/redis_password)" ping']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

secrets:
  database_password:
    file: ./.ci-secrets/database_password
  redis_password:
    file: ./.ci-secrets/redis_password
  jwt_secret:
    file: ./.ci-secrets/jwt_secret

networks:
  expense-api-network:
    driver: bridge
