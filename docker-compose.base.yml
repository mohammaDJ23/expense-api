x-common-variables: &common-variables
  TZ: UTC

x-common-config: &common-config
  user: '10001:10001'
  init: true
  stop_signal: SIGTERM
  stop_grace_period: 30s
  logging:
    driver: 'json-file'
    options:
      max-size: '10m'
      max-file: '3'
      mode: 'non-blocking'
      max-buffer-size: '4m'
      tag: '{{.Name}}/{{.ID}}'

x-security-config: &security-config
  security_opt:
    - no-new-privileges:true
  cap_drop:
    - ALL

x-readonly-filesystem: &readonly-filesystem
  read_only: true

x-health-check: &health-check
  healthcheck:
    test:
      [
        'CMD',
        'node',
        '-e',
        "const http = require('http'); const req = http.request({ hostname: 'localhost', port: process.env.PORT, path: '/health', timeout: 5000 }, (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }); req.on('error', () => process.exit(1)); req.end();",
      ]
    interval: 30s
    timeout: 10s
    start_period: ${HEALTH_START_PERIOD:-60s}
    retries: 3

networks:
  expense-api-network:
    driver: bridge

services:
  expense-api:
    <<: [*common-config, *security-config, *readonly-filesystem, *health-check]
    hostname: expense-api
    environment:
      <<: *common-variables
    networks:
      - expense-api-network
    sysctls:
      net.core.somaxconn: 1024
      net.ipv4.tcp_syncookies: 1
    ulimits:
      nproc: 65535
      nofile:
        soft: 20000
        hard: 40000
