name: Master Pipeline

on:
  workflow_run:
    workflows: ['PR Validation']
    types:
      - completed
    branches:
      - master

concurrency:
  group: ci-master-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

env:
  APP_NAME: expense-api
  HEAD_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

jobs:
  run-and-test:
    if: github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.HEAD_SHA }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - uses: ./.github/actions/run-and-test-docker-image
        with:
          app_name: ${{ env.APP_NAME }}
          image_name: ${{ env.APP_NAME }}-ci:${{ env.HEAD_SHA }}
