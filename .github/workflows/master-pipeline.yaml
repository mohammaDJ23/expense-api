name: Master Pipeline

on:
  workflow_run:
    workflows: ['PR Validation']
    types:
      - completed
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

jobs:
  docker-build-production:
    if: >
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Show commit info
        run: |
          echo "Deploying SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "From workflow: ${{ github.event.workflow_run.name }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build production image
        run: |
          docker build \
            --target production \
            -t expense-api-production .

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'expense-api-production'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          skip-dirs: '/usr/local/lib/node_modules/npm'

      - name: Docker Scout
        uses: docker/scout-action@v1
        with:
          command: cves
          image: expense-api-production
          exit-code: true
          only-severities: critical,high
          ignore-base: true

      - name: Snyk container scan
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: expense-api-production
          args: |
            --severity-threshold=high
            --exclude=/usr/local/lib/node_modules/npm

      - name: Test production image
        run: |
          set -euo pipefail

          IMAGE="expense-api-production"
          CONTAINER="${IMAGE}-$(date +%s)"
          PORT=$(grep -E '^PORT=' .env.production | cut -d'=' -f2 || echo "3000")

          cleanup() { 
            echo "Cleaning up container: $CONTAINER"
            docker stop "$CONTAINER" 2>/dev/null || true
            docker rm -f "$CONTAINER" 2>/dev/null || true
          }

          trap cleanup EXIT INT TERM

          echo "Starting $IMAGE..."
          docker run -d \
            --rm \
            --name "$CONTAINER" \
            --user "10001:10001" \
            --read-only \
            --cap-drop=ALL \
            --security-opt no-new-privileges=true \
            --memory="512m" \
            --cpus="1.0" \
            --pids-limit=100 \
            --log-driver=json-file \
            --log-opt max-size=10m \
            --log-opt max-file=3 \
            --env-file .env.production \
            -e "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" \
            -e "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            -e "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" \
            "$IMAGE"

          sleep 10

          HEALTH_CHECK_TIMER=60
          HEALTH_OK=false
          echo "Waiting for health check (${HEALTH_CHECK_TIMER}s max)..."

          for ((i=1; i<=HEALTH_CHECK_TIMER; i++)); do
            echo -ne "⏳ Checking... ${i}/${HEALTH_CHECK_TIMER}s\r"

            if ! docker ps --filter "name=$CONTAINER" --format "{{.Names}}" | grep -q "^$CONTAINER$"; then
              echo "❌ Container stopped unexpectedly"
              docker logs "$CONTAINER"
              HEALTH_OK=false
              break
            fi
            
            if docker exec "$CONTAINER" \
              sh -c "curl -f -s --max-time 3 http://localhost:$PORT/health >/dev/null"; then
              echo "✅ Health OK after ${i}s"
              HEALTH_OK=true
              break
            fi
            
            sleep 1
          done

          echo ""

          if [ "$HEALTH_OK" = "true" ]; then
            echo "✓ Test passed"
          else
            echo "✗ Health check failed"
            echo "Container logs:"
            docker logs "$CONTAINER" || true
            exit 1
          fi

      # - name: Push to DockerHub
      #   run: |
      #     docker tag expense-api-production ${{ secrets.DOCKERHUB_USERNAME }}/expense-api:${{ github.sha }}
      #     docker tag expense-api-production ${{ secrets.DOCKERHUB_USERNAME }}/expense-api:latest
      #     docker push ${{ secrets.DOCKERHUB_USERNAME }}/expense-api:${{ github.sha }}
      #     docker push ${{ secrets.DOCKERHUB_USERNAME }}/expense-api:latest
