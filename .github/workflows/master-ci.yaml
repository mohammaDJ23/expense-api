name: Master CI

on:
  workflow_run:
    workflows: ['PR CI']
    types:
      - completed
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

env:
  APP_NAME: ${{ vars.APP_NAME }}
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
  SHA: ${{ github.event.workflow_run.head_sha || github.sha }}

jobs:
  run-and-test:
    if: github.event.workflow_run.conclusion == 'success'
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the source
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SHA }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup the variables
        id: variables
        uses: docker://${{ env.DOCKER_USERNAME }}-${{ env.APP_NAME }}/scripts/ci/docker/vars:latest
        env:
          APP_NAME: ${{ env.APP_NAME }}
          MODE: ci

      - name: Build the docker image
        id: build-image
        uses: docker://${{ env.DOCKER_USERNAME }}-${{ env.APP_NAME }}/scripts/ci/docker/build:latest
        env:
          IMAGE_NAME: ${{ steps.variables.output.IMAGE_NAME }}
          TAG: ${{ env.SHA }}

      - name: Scan the docker image
        uses: ./.github/actions/scan-docker-image
        with:
          image_name: ${{ steps.variables.output.IMAGE_NAME }}

      - name: Run the docker image
        uses: docker://${{ env.DOCKER_USERNAME }}-${{ env.APP_NAME }}/scripts/ci/docker/run:latest
        env:
          COMPOSE_FILE: ${{ steps.variables.output.COMPOSE_FILE }}
          STACK_NAME: ${{ steps.variables.output.STACK_NAME }}
          SERVICE_NAME: ${{ steps.variables.output.SERVICE_NAME }}
          IMAGE_NAME: ${{ steps.build-image.output.IMAGE_LATEST }}
          ENVIRONMENT: ${{ steps.variables.output.ENVIRONMENT }}
          SECRETS: 'database_password=${{ secrets.DATABASE_PASSWORD }};redis_password=${{ secrets.REDIS_PASSWORD }};JWT_SECRET=${{ secrets.JWT_SECRET }}'

      - name: Check the healthy
        uses: docker://${{ env.DOCKER_USERNAME }}-${{ env.APP_NAME }}/scripts/ci/docker/checkHealthy:latest
        env:
          SERVICE_NAME: ${{ steps.variables.output.SERVICE_NAME }}

      - name: Cleanup
        uses: docker://${{ env.DOCKER_USERNAME }}-${{ env.APP_NAME }}/scripts/ci/docker/cleanup:latest
        env:
          STACK_NAME: ${{ steps.variables.output.STACK_NAME }}
