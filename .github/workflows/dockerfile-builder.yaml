name: Dockerfile Builder

on:
  workflow_call:
    inputs:
      sha:
        description: Commit SHA to use for tagging
        required: true
        type: string
      directory:
        description: Directory pattern to check for changes
        required: false
        default: 'scripts/ci/**'
        type: string

env:
  APP_NAME: ${{ vars.APP_NAME }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      images_json: ${{ steps.build-images.outputs.images_json }}
      built_count: ${{ steps.build-images.outputs.built_count }}
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Find changed Dockerfiles
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: ${{ inputs.directory }}

      - name: Build Docker images
        id: build-images
        run: |
          ALL_CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          
          IMAGES_JSON='['
          BUILT_COUNT=0
          FIRST=true
          
          if [ -z "${ALL_CHANGED_FILES}" ]; then
            echo "‚ÑπÔ∏è No files were changed"
            echo "images_json=[]" >> $GITHUB_OUTPUT
            echo "built_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          DOCKERFILES=$(echo "${ALL_CHANGED_FILES}" | tr ' ' '\n' | grep "Dockerfile$")
          DOCKERFILES_COUNT=$(echo "${DOCKERFILES}" | wc -l)
          
          while IFS= read -r file; do
            [ -z "${file}" ] && continue
            
            echo ""
            
            if [ -f "${file}" ]; then
              dir_path=$(dirname "${file}")
              
              IMAGE_NAME="${DOCKER_USERNAME}-${APP_NAME}/${dir_path}"
              IMAGE_NAME=$(echo "${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')
              
              echo "‚ÑπÔ∏è Building: ${IMAGE_NAME}"
              
              IMAGE_SHA="${IMAGE_NAME}:${{ inputs.sha }}"
              IMAGE_LATEST="${IMAGE_NAME}:latest"
              
              if docker build \
                -t "${IMAGE_SHA}" \
                -t "${IMAGE_LATEST}" \
                -f "${dir_path}/Dockerfile" \
                "." 2>&1; then
                
                echo "‚úÖ Successfully built:"
                echo "    image_sha: ${IMAGE_SHA}"
                echo "    image_latest: ${IMAGE_LATEST}"
                
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  IMAGES_JSON="${IMAGES_JSON},"
                fi
                
                IMAGES_JSON="${IMAGES_JSON}{\"name\":\"${IMAGE_NAME}\",\"sha\":\"${IMAGE_SHA}\",\"latest\":\"${IMAGE_LATEST}\"}"
                BUILT_COUNT=$((BUILT_COUNT + 1))
              else
                echo "  ‚ùå Could not build: ${IMAGE_NAME}"
                exit 1
              fi
            else
              echo "  ‚ùå No directory exists: ${file}"
              exit 1
            fi
          done < <(echo "$DOCKERFILES")

          IMAGES_JSON="${IMAGES_JSON}]"

          echo ""
          echo ""
          echo "‚úÖ All ${BUILT_COUNT}, from ${DOCKERFILES_COUNT} files, images created."
          echo ""
          echo ""

          echo "images_json=${IMAGES_JSON}" >> $GITHUB_OUTPUT
          echo "built_count=${BUILT_COUNT}" >> $GITHUB_OUTPUT

      - name: Save Docker images
        if: steps.build-images.outputs.built_count > 0
        run: |
          echo "üíæ Saving Docker images..."
          
          IMAGES_JSON="${{ steps.build-images.outputs.images_json }}"
          
          mkdir -p saved-images

          UNMASKED_JSON=$(echo "$IMAGES_JSON" | sed "s/\\\"\\*\\*\\*-/\\\"$DOCKER_USERNAME-/g")
          
          COUNT=$(echo "${UNMASKED_JSON}" | jq 'length')
          
          for ((i=0; i<COUNT; i++)); do
            NAME=$(echo "${UNMASKED_JSON}" | jq -r ".[$i].name")
            SHA=$(echo "${UNMASKED_JSON}" | jq -r ".[$i].sha")
            LATEST=$(echo "${UNMASKED_JSON}" | jq -r ".[$i].latest")
            
            echo "Saving $NAME..."
            
            SHA_FILE=$(echo "$SHA" | tr '/' '_' | tr ':' '-').tar
            LATEST_FILE=$(echo "$LATEST" | tr '/' '_' | tr ':' '-').tar


            if docker save -o "saved-images/${SHA_FILE}" "${SHA}"; then
              echo "  ‚úÖ Successfully saved ${SHA}"
            else
              echo "  ‚ùå Failed to save ${SHA}"
              exit 1
            fi

            if docker save -o "saved-images/${LATEST_FILE}" "${LATEST}"; then
              echo "  ‚úÖ Successfully saved ${LATEST}"
            else
              echo "  ‚ùå Failed to save ${LATEST}"
              exit 1
            fi
          done
          
          echo ""
          echo ""
          echo "‚úÖ Saved all images"
          echo ""
          echo ""

      - name: Upload saved images
        if: steps.build-images.outputs.built_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: saved-images/
          retention-days: 1

  security-scan:
    needs: build
    if: needs.build.outputs.built_count > 0
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include: ${{ fromJson(needs.build.outputs.images_json) }}
    permissions:
      contents: read
    steps:
      - name: Download saved images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: saved-images

      - name: Load Docker images
        uses: ./.github/actions/load-docker-image
        with:
          name: ${{ matrix.name }}
          image_sha: ${{ matrix.sha }}
          image_latest: ${{ matrix.latest }}
          artifact_path: saved-images

      - name: Scan the docker image
        uses: ./.github/actions/scan-docker-image
        with:
          image_name: ${{ matrix.latest }}

  push:
    needs: [build, security-scan]
    if: needs.build.outputs.built_count > 0
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include: ${{ fromJson(needs.build.outputs.images_json) }}
    permissions:
      contents: read
    steps:
      - name: Download saved images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: saved-images

      - name: Load Docker image
        uses: ./.github/actions/load-docker-image
        with:
          image_latest: ${{ matrix.latest }}
          image_sha: ${{ matrix.sha }}
          artifact_path: saved-images

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Push images to DockerHub
        run: |
          echo "üöÄ Pushing images to DockerHub..."

          push_tag() {
            local tag="$1"
            if docker image inspect "$tag" > /dev/null 2>&1; then
              echo "üê≥ Pushing $tag..."
              if docker push "$tag"; then
                echo "‚úÖ Successfully pushed $tag"
                return 0
              else
                echo "‚ùå Failed to push $tag"
                return 1
              fi
            else
              echo "‚ö†Ô∏è  $tag not found locally"
              return 2
            fi
          }

          push_tag "${{ matrix.latest }}"
          push_tag "${{ matrix.sha }}"

          echo "üìä Push operation completed"
