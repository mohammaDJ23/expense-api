name: Dockerfile Builder

on:
  workflow_call:
    inputs:
      sha:
        description: Commit SHA to use for tagging
        required: true
        type: string
      directory:
        description: Directory pattern to check for changes
        required: false
        default: 'scripts/ci/**'
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

env:
  APP_NAME: ${{ vars.APP_NAME }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      images_json: ${{ steps.build-images.outputs.images_json }}
      built_count: ${{ steps.build-images.outputs.built_count }}
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Find changed Dockerfiles
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: ${{ inputs.directory }}

      - name: Build the docker images
        id: build-images
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          ALL_CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"

          IMAGES_JSON='[]'
          BUILT_COUNT=0

          if [ -z "${ALL_CHANGED_FILES}" ]; then
            echo "‚ÑπÔ∏è No files were changed"
            echo "images_json=$IMAGES_JSON" >> $GITHUB_OUTPUT
            echo "built_count=$BUILT_COUNT" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "${ALL_CHANGED_FILES}" | tr ' ' '\n' > changed_files.txt

          while IFS= read -r file || [ -n "$file" ]; do
            [ -z "$file" ] && continue

            echo ""
            
            if [ -f "$file" ]; then
              dir_path=$(dirname "$file")
              script_name="$dir_path"

              IMAGE_NAME="${DOCKERHUB_USERNAME}-${APP_NAME}/$script_name"

              echo "‚ÑπÔ∏è Building: $IMAGE_NAME"
              
              if docker build \
                -t ${IMAGE_NAME}:latest \
                -t ${IMAGE_NAME}:${{ inputs.sha }} \
                "$dir_path" 2>&1; then
                
                echo "‚úÖ Successfully built $IMAGE_NAME"
                
                IMAGE_JSON=$(jq -n \
                  --arg name "$IMAGE_NAME" \
                  --arg latest "${IMAGE_NAME}:latest" \
                  --arg sha "${IMAGE_NAME}:${{ inputs.sha }}" \
                  '{name: $name, latest: $latest, sha: $sha}')
                
                IMAGES_JSON=$(echo "$IMAGES_JSON" | jq --argjson img "$IMAGE_JSON" '. += [$img]')
                ((BUILT_COUNT++))
              else
                echo "‚ùå Failed to build $IMAGE_NAME"
              fi
            else
              echo "‚ö†Ô∏è  Warning: '$file' not found"
            fi

            echo ""
          done < changed_files.txt

          echo "images_json=$IMAGES_JSON" >> $GITHUB_OUTPUT
          echo "built_count=$BUILT_COUNT" >> $GITHUB_OUTPUT

      - name: Save Docker images
        if: steps.build-images.outputs.built_count > 0
        run: |
          echo "üíæ Saving Docker images..."

          IMAGES_JSON=${{ steps.build-images.outputs.images_json }}

          mkdir -p saved-images

          echo "${IMAGES_JSON}" | jq -r '.[] | select(true) | .latest + "|" + .sha' | while IFS='|' read -r latest_tag sha_tag; do
            echo "Saving $latest_tag..."
            LATEST_FILENAME=$(echo "$latest_tag" | sed 's|/|_|g' | sed 's|:|-|g').tar
            docker save -o "saved-images/${LATEST_FILENAME}" "$latest_tag"
            
            echo "Saving $sha_tag..."
            SHA_FILENAME=$(echo "$sha_tag" | sed 's|/|_|g' | sed 's|:|-|g').tar
            docker save -o "saved-images/${SHA_FILENAME}" "$sha_tag"
          done

          echo "‚úÖ Saved all images"

          ls -la saved-images/

      - name: Upload saved images
        if: steps.build-images.outputs.built_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: saved-images/
          retention-days: 1

  security-scan:
    needs: build
    if: needs.build.outputs.built_count > 0
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.build.outputs.images_json) }}
    permissions:
      contents: read
    steps:
      - name: Download saved images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: saved-images

      - name: Load Docker images
        uses: ./.github/actions/load-docker-image
        with:
          image_latest: ${{ matrix.image.latest }}
          image_sha: ${{ matrix.image.sha }}
          artifact_path: saved-images

      - name: Scan the docker image
        uses: ./.github/actions/scan-docker-image
        with:
          image_name: ${{ matrix.image.latest }}

  push:
    needs: [build, security-scan]
    if: needs.build.outputs.built_count > 0
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: ${{ fromJson(needs.build.outputs.images_json) }}
    permissions:
      contents: read
    steps:
      - name: Download saved images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: saved-images

      - name: Load Docker image
        uses: ./.github/actions/load-docker-image
        with:
          image_latest: ${{ matrix.image.latest }}
          image_sha: ${{ matrix.image.sha }}
          artifact_path: saved-images

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Push images to DockerHub
        run: |
          echo "üöÄ Pushing images to DockerHub..."

          push_tag() {
            local tag="$1"
            if docker image inspect "$tag" > /dev/null 2>&1; then
              echo "üê≥ Pushing $tag..."
              if docker push "$tag"; then
                echo "‚úÖ Successfully pushed $tag"
                return 0
              else
                echo "‚ùå Failed to push $tag"
                return 1
              fi
            else
              echo "‚ö†Ô∏è  $tag not found locally"
              return 2
            fi
          }

          push_tag "${{ matrix.image.latest }}"
          push_tag "${{ matrix.image.sha }}"

          echo "üìä Push operation completed"
