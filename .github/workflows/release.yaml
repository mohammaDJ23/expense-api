name: Release

on:
  workflow_run:
    workflows: ['Master Pipeline']
    types:
      - completed
    branches:
      - master

concurrency:
  group: cd-master
  cancel-in-progress: true

env:
  APP_NAME: expense-api

jobs:
  manual-approval:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: production-release
    outputs:
      approved_sha: ${{ github.event.workflow_run.head_sha }}
      master_run_id: ${{ github.event.workflow_run.id }}
    steps:
      - name: ðŸ›‘ Manual Approval Required
        run: |
          echo "=========================================="
          echo "ðŸ›‘ RELEASE APPROVAL REQUIRED"
          echo "=========================================="
          echo ""
          echo "âœ… Master Pipeline Verification:"
          echo "   Run #: ${{ github.event.workflow_run.run_number }}"
          echo "   SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "   By: ${{ github.event.workflow_run.actor.login }}"
          echo ""
          echo "ðŸ“‹ Before approving, verify:"
          echo "   1. Master Pipeline completed successfully"
          echo "   2. No Master Pipeline is currently running"
          echo "   3. You want to proceed with this release"
          echo ""
          echo "âš ï¸  This release will use SHA:"
          echo "   ${{ github.event.workflow_run.head_sha }}"
          echo ""
          echo "=========================================="

  create-version:
    needs: manual-approval
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}-${{ env.APP_NAME }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      commit_sha: ${{ steps.get-version.outputs.commit_sha }}
      image_ref: ${{ steps.get-version.outputs.image_ref }}
      latest_image: ${{ steps.get-version.outputs.latest_image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.manual-approval.outputs.approved_sha }}
          fetch-depth: 0

      - uses: ./.github/actions/setup-node/action.yaml

      - name: Create a new version
        id: get-version
        run: |
          set -euxo pipefail
          
          echo "ðŸ”” Starting Semantic Release process..."
          
          CURRENT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${CURRENT_SHA}" >> $GITHUB_OUTPUT

          CURRENT_VERSION=$(jq -r '.version' package.json)
          echo "Current version: ${CURRENT_VERSION}"

          SEMANTIC_OUTPUT=$(npx semantic-release --dry-run 2>&1 || true)
          echo "Semantic-release dry run output:"
          echo "${SEMANTIC_OUTPUT}"

          PHRASE="The next release version is"
          LINE=$(echo "${SEMANTIC_OUTPUT}" | grep "${PHRASE}" | head -n 1)

          if [[ -z "${LINE}" ]]; then
            echo "âŒ No new version found."
            exit 1
          fi
            
          NEW_VERSION="${LINE#*$PHRASE }"
          if [[ -z "${NEW_VERSION}" || "${NEW_VERSION}" == "${CURRENT_VERSION}" ]]; then
            echo "âŒ No new version created."
            exit 1
          fi

          npx semantic-release

          echo "âœ… New version created: ${NEW_VERSION}"

          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT

          IMAGE_REF="${IMAGE_NAME}:${NEW_VERSION}"
          echo "image_ref=${IMAGE_REF}" >> $GITHUB_OUTPUT
          
          LATEST_IMAGE="${IMAGE_NAME}:latest"
          echo "latest_image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT

  run-and-test:
    needs: create-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-version.outputs.commit_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build, run and test the versioned image
        uses: ./.github/actions/run-and-test-docker-image/action.yaml
        with:
          app_name: ${{ env.APP_NAME }}
          image_name: ${{ needs.create-version.outputs.image_ref }}

      - name: Build, run and test the latest image
        uses: ./.github/actions/run-and-test-docker-image/action.yaml
        with:
          app_name: ${{ env.APP_NAME }}
          image_name: ${{ needs.create-version.outputs.latest_image }}

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push the image to DockerHub
        env:
          IMAGE_REF: ${{ needs.create-version.outputs.image_ref }}
          LATEST_IMAGE: ${{ needs.create-version.outputs.latest_image }}
        run: |
          echo "ðŸ“¤ Pushing to DockerHub..."
          echo "Images: ${IMAGE_REF} and ${LATEST_IMAGE}"

          docker push ${IMAGE_REF}
          docker push ${LATEST_IMAGE}

          echo "âœ… Successfully pushed: ${IMAGE_REF} and ${LATEST_IMAGE}"
          echo "ðŸŽ‰ Images published!"
        
      - name: Log out from DockerHub
        if: always()
        run: docker logout

  release-summary:
    needs: [manual-approval, create-version, run-and-test]
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.create-version.outputs.version }}
      IMAGE_REF: ${{ needs.create-version.outputs.image_ref }}
      LATEST_IMAGE: ${{ needs.create-version.outputs.latest_image }}
      WORKFLOW: ${{ github.workflow }}
      RUN_NUMBER: ${{ github.event.workflow_run.run_number }}
      ORIGINAL_SHA: ${{ needs.manual-approval.outputs.approved_sha }}
      UPDATED_SHA: ${{ needs.create-version.outputs.commit_sha }}
    steps:
      - name: Release Summary
        run: |
          echo "ðŸš€ RELEASE WORKFLOW SUMMARY"
          echo "==========================="
          echo ""
          echo "Workflow: ${WORKFLOW}"
          echo "Triggered by: Master Pipeline #${RUN_NUMBER}"
          echo "Original SHA: ${ORIGINAL_SHA}"
          echo "Updated SHA: ${UPDATED_SHA}"
          echo ""
          
          echo "âœ… NEW RELEASE CREATED!"
          echo "Version: v${VERSION}"
          echo ""
          echo "ðŸ“¦ Docker Images Published:"
          echo "   ${IMAGE_REF}"
          echo "   ${LATEST_IMAGE}"
          echo ""
