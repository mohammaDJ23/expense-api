name: Release

on:
  workflow_run:
    workflows: ['Master CI']
    types:
      - completed
    branches:
      - master

concurrency:
  group: release
  cancel-in-progress: true

env:
  APP_NAME: ${{ vars.APP_NAME }}
  SHA: ${{ github.event.workflow_run.head_sha }}
  RUN_ID: ${{ github.event.workflow_run.id }}
  RUN_NUMBER: ${{ github.event.workflow_run.run_number }}
  BY: ${{ github.event.workflow_run.actor.login }}
  WORKFLOW: ${{ github.workflow }}
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  manual-approval:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: production-release
    steps:
      - name: üõë Manual Approval Required
        run: |
          echo "=========================================="
          echo "üõë RELEASE APPROVAL REQUIRED"
          echo "=========================================="
          echo ""
          echo "‚úÖ Master Pipeline Verification:"
          echo "   Run #: ${{ env.RUN_NUMBER }}"
          echo "   SHA: ${{ env.SHA }}"
          echo "   By: ${{ env.BY }}"
          echo ""
          echo "üìã Before approving, verify:"
          echo "   1. Master Pipeline completed successfully"
          echo "   2. No Master Pipeline is currently running"
          echo "   3. You want to proceed with this release"
          echo ""
          echo "‚ö†Ô∏è  This release will use SHA:"
          echo "   ${{ env.SHA }}"
          echo ""
          echo "=========================================="

  create-version:
    needs: manual-approval
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      commit_sha: ${{ steps.get-commit-sha.outputs.commit_sha }}
    steps:
      - name: Checkout the source
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SHA }}
          fetch-depth: 0

      - name: Install node and node_modules
        uses: ./.github/actions/setup-node

      - name: Detect commit_sha
        id: get-commit-sha
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/detectCommitSha:latest

      - name: Create version
        id: get-version
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/createVersion:latest

  run-test-push:
    needs: create-version
    runs-on: ubuntu-latest
    output:
      IMAGE_LATEST: ${{ steps.build-image.output.IMAGE_LATEST }}
      IMAGE_TAG: ${{ steps.build-image.output.IMAGE_TAG }}
    steps:
      - name: Checkout the source
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-version.outputs.commit_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup the variables
        id: variables
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/vars:latest
        env:
          APP_NAME: ${{ env.APP_NAME }}
          MODE: production

      - name: Build the docker image
        id: build-image
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/docker/build:latest
        env:
          IMAGE_NAME: ${{ steps.variables.output.IMAGE_NAME }}
          TAG: ${{ env.SHA }}

      - name: Scan the docker image
        uses: ./.github/actions/scan-docker-image
        with:
          image_name: ${{ steps.variables.output.IMAGE_NAME }}

      - name: Run the docker image
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/docker/run:latest
        env:
          COMPOSE_FILE: ${{ steps.variables.output.COMPOSE_FILE }}
          STACK_NAME: ${{ steps.variables.output.STACK_NAME }}
          SERVICE_NAME: ${{ steps.variables.output.SERVICE_NAME }}
          IMAGE_NAME: ${{ steps.build-image.output.IMAGE_LATEST }}
          ENVIRONMENT: ${{ steps.variables.output.ENVIRONMENT }}
          SECRETS: 'database_password=${{ secrets.DATABASE_PASSWORD }};redis_password=${{ secrets.REDIS_PASSWORD }};JWT_SECRET=${{ secrets.JWT_SECRET }}'

      - name: Check the healthy
        uses: docker://$.DOCKER_USERNAME-$APP_NAME/scripts/ci/docker/checkHealthy:latest
        env:
          SERVICE_NAME: ${{ steps.variables.output.SERVICE_NAME }}

      - name: Cleanup
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/docker/cleanup:latest
        env:
          STACK_NAME: ${{ steps.variables.output.STACK_NAME }}

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Push the image, tagged, to DockerHub
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/docker/push:latest
        env:
          IMAGE_TAG: ${{ needs.build-image.outputs.IMAGE_TAG }}

      - name: Push the image, latest, to DockerHub
        uses: docker://$DOCKER_USERNAME-$APP_NAME/scripts/ci/docker/push:latest
        env:
          IMAGE_LATEST: ${{ needs.build-image.outputs.IMAGE_LATEST }}

      - name: Log out from DockerHub
        if: always()
        run: docker logout

  release-summary:
    needs: [manual-approval, create-version, run-test-push]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.create-version.outputs.version }}
      IMAGE_TAG: ${{ needs.run-test-push.outputs.IMAGE_TAG }}
      IMAGE_LATEST: ${{ needs.run-test-push.outputs.IMAGE_LATEST }}
      WORKFLOW: ${{ env.WORKFLOW }}
      RUN_NUMBER: ${{ env.RUN_NUMBER }}
      ORIGINAL_SHA: ${{ env.SHA }}
      UPDATED_SHA: ${{ needs.create-version.outputs.commit_sha }}
    steps:
      - name: Release Summary
        run: |
          echo "üöÄ RELEASE WORKFLOW SUMMARY"
          echo "==========================="
          echo ""
          echo "Workflow: ${WORKFLOW}"
          echo "Triggered by: Master Pipeline #${RUN_NUMBER}"
          echo "Original SHA: ${ORIGINAL_SHA}"
          echo "Updated SHA: ${UPDATED_SHA}"
          echo ""

          echo "‚úÖ NEW RELEASE CREATED!"
          echo "New Version: v${VERSION}"
          echo ""
          echo "üì¶ Docker Images Published:"
          echo "   ${IMAGE_TAG}"
          echo "   ${IMAGE_LATEST}"
          echo ""
