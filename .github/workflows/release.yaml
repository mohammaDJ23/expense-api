name: Release

on:
  workflow_run:
    workflows: ['Master Pipeline']
    types:
      - completed
    branches:
      - master

concurrency:
  group: cd-master
  cancel-in-progress: true

env:
  APP_NAME: expense-api

jobs:
  manual-approval:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: production-release
    outputs:
      approved_sha: ${{ github.event.workflow_run.head_sha }}
      master_run_id: ${{ github.event.workflow_run.id }}
    steps:
      - name: ðŸ›‘ Manual Approval Required
        run: |
          echo "=========================================="
          echo "ðŸ›‘ RELEASE APPROVAL REQUIRED"
          echo "=========================================="
          echo ""
          echo "âœ… Master Pipeline Verification:"
          echo "   Run #: ${{ github.event.workflow_run.run_number }}"
          echo "   SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "   By: ${{ github.event.workflow_run.actor.login }}"
          echo ""
          echo "ðŸ“‹ Before approving, verify:"
          echo "   1. Master Pipeline completed successfully"
          echo "   2. No Master Pipeline is currently running"
          echo "   3. You want to proceed with this release"
          echo ""
          echo "âš ï¸  This release will use SHA:"
          echo "   ${{ github.event.workflow_run.head_sha }}"
          echo ""
          echo "=========================================="

  create-version:
    needs: manual-approval
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      previous_version: ${{ steps.get-previous-version.outputs.previous_version }}
      commit_sha: ${{ steps.get-commit-sha.outputs.commit_sha }}
      image_name: ${{ steps.create-image-names.outputs.image_name }}
      latest_image: ${{ steps.create-image-names.outputs.latest_image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.manual-approval.outputs.approved_sha }}
          fetch-depth: 0

      - uses: ./.github/actions/setup-node/action.yaml

      - name: Get commit_sha
        id: get-commit-sha
        run: |
          set -euxo pipefail

          echo "Getting commit_sha..."

          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT

          echo "âœ… The commit_sha is ${COMMIT_SHA}."

      - name: Get previous version
        id: get-previous-version
        run: |
          set -euxo pipefail

          echo "Getting previous version..."

          PREVIOUS_VERSION=$(jq -r '.version' package.json)
          echo "preivous_version=${PREVIOUS_VERSION}" >> $GITHUB_OUTPUT

          echo "âœ… The previous version is ${PREVIOUS_VERSION}."

      - name: Get new version by the dry mode
        id: get-version
        run: |
          set -euxo pipefail

          SEMANTIC_OUTPUT=$(npx semantic-release --dry-run 2>&1 || true)
          echo "Semantic-release dry run output:"
          echo "${SEMANTIC_OUTPUT}"

          PHRASE="The next release version is"
          LINE=$(echo "${SEMANTIC_OUTPUT}" | grep "${PHRASE}" | head -n 1)

          if [[ -z "${LINE}" ]]; then
            echo "âŒ No new version found."
            exit 1
          fi
            
          PREVIOUS_VERSION="${{ steps.get-previous-version.outputs.previous_version }}"

          VERSION="${LINE#*$PHRASE }"
          if [[ -z "${VERSION}" || "${VERSION}" == "${PREVIOUS_VERSION}" ]]; then
            echo "âŒ No new version created."
            exit 1
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… The new version exists: ${VERSION}"

      - name: Create a new version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail

          echo "ðŸ”” Starting Semantic Release process..."
          npx semantic-release

          echo "âœ… Semantic Release was successfull..."

      - name: Create the docker image names
        id: create-image-names
        run: |
          set -euxo pipefail

          VERSION="${{ steps.get-version.outputs.version }}"
          NAME="${{ secrets.DOCKERHUB_USERNAME }}-${{ env.APP_NAME }}"

          IMAGE_NAME="${NAME}:${VERSION}"
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT

          echo "âœ… The new image with version is ${IMAGE_NAME}"

          LATEST_IMAGE="${NAME}:latest"
          echo "latest_image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT

          echo "âœ… The new image with latest version is ${LATEST_IMAGE}"

  run-test-push:
    needs: create-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-version.outputs.commit_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build, run and test the versioned image
        uses: ./.github/actions/run-and-test-docker-image/action.yaml
        with:
          app_name: ${{ env.APP_NAME }}
          image_name: ${{ needs.create-version.outputs.image_name }}

      - name: Build, run and test the latest image
        uses: ./.github/actions/run-and-test-docker-image/action.yaml
        with:
          app_name: ${{ env.APP_NAME }}
          image_name: ${{ needs.create-version.outputs.latest_image }}

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push the image to DockerHub
        env:
          IMAGE_NAME: ${{ needs.create-version.outputs.image_name }}
          LATEST_IMAGE: ${{ needs.create-version.outputs.latest_image }}
        run: |
          echo "ðŸ“¤ Pushing to DockerHub..."
          echo "Images: ${IMAGE_NAME} and ${LATEST_IMAGE}"

          docker push ${IMAGE_NAME}
          docker push ${LATEST_IMAGE}

          echo "âœ… Successfully pushed: ${IMAGE_NAME} and ${LATEST_IMAGE}"
          echo "ðŸŽ‰ Images published!"

      - name: Log out from DockerHub
        if: always()
        run: docker logout

  release-summary:
    needs: [manual-approval, create-version, run-and-test]
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.create-version.outputs.version }}
      PREVIOUS_VERSION: ${{ needs.create-version.outputs.previous_version }}
      IMAGE_NAME: ${{ needs.create-version.outputs.image_name }}
      LATEST_IMAGE: ${{ needs.create-version.outputs.latest_image }}
      WORKFLOW: ${{ github.workflow }}
      RUN_NUMBER: ${{ github.event.workflow_run.run_number }}
      ORIGINAL_SHA: ${{ needs.manual-approval.outputs.approved_sha }}
      UPDATED_SHA: ${{ needs.create-version.outputs.commit_sha }}
    steps:
      - name: Release Summary
        run: |
          echo "ðŸš€ RELEASE WORKFLOW SUMMARY"
          echo "==========================="
          echo ""
          echo "Workflow: ${WORKFLOW}"
          echo "Triggered by: Master Pipeline #${RUN_NUMBER}"
          echo "Original SHA: ${ORIGINAL_SHA}"
          echo "Updated SHA: ${UPDATED_SHA}"
          echo ""

          echo "âœ… NEW RELEASE CREATED!"
          echo "Previous Version: v${PREVIOUS_VERSION}"
          echo "New Version: v${VERSION}"
          echo ""
          echo "ðŸ“¦ Docker Images Published:"
          echo "   ${IMAGE_NAME}"
          echo "   ${LATEST_IMAGE}"
          echo ""
